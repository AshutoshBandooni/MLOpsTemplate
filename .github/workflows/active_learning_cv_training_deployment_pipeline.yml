name: active_learning_cv_training_deployment
on: 
  workflow_dispatch:
  repository_dispatch:
    types: training
jobs:
  Train-Deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Setup python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8' # Version range or exact version of a Python version to use, using SemVer's version range syntax 
      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade build
          python -m pip install --upgrade twine
          python -m pip install --upgrade azureml-sdk
          python -m pip install --upgrade strictyaml
      - name: AZ Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_JAMES }}

      - name: Install az ml & set default values for AML
        run: |
          az extension add -n ml -y
          az configure --defaults group=azureml workspace=ws01ent location=westus2
    
      - name: run training pipeline
        uses: ./.github/actions/aml-job-create
        with:
          jobFile: src/active_learning_cv/core/pipelines/training_pipeline.yml
      - name: Update properties in deployment yml file
        env: 
          SP_SECRET: ${{ secrets.SP_SECRET_JAMES}}
          SP_ID: ${{ secrets.SP_ID_JAMES}}
          TENANT_ID: ${{ secrets.TENANT_ID_JAMES}}
          SUBSCRIPTION_ID: ${{ secrets.SUBSCRIPTION_ID_JAMES}}
        run: |
          python src/active_learning_cv/core/scoring/update_deployment.py --model_name ActiveLearningCV_Model --job_file src/active_learning_cv/core/scoring/realtime_score.yml
      - name: Run deployment step
        run: |
          az ml online-deployment update --name blue --endpoint image-rt-scoring  -f src/active_learning_cv/core/scoring/realtime_score.yml